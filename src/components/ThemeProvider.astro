<script is:inline>
	const lightModePref = window.matchMedia('(prefers-color-scheme: light)')
	let isAnimating = false

	// Get user preference from local storage or from browser preference
	function getUserPref() {
		const storedTheme = localStorage.getItem('theme') ?? undefined
		return storedTheme || (lightModePref.matches ? 'light' : 'dark')
	}

	function setTheme(newTheme, event) {
		if (newTheme !== 'light' && newTheme !== 'dark') {
			return console.log(`Invalid theme value '${newTheme}' received. Expected 'light' or 'dark'.`)
		}

		if (isAnimating) return

		localStorage.setItem('theme', newTheme)

		const root = document.documentElement

		// if current dark theme and new theme is dark, return
		if (newTheme === 'dark' && root.classList.contains('dark')) {
			return
		} else if (newTheme === 'light' && !root.classList.contains('dark')) {
			return
		}

		// Use View Transition API with circular reveal
		if (document.startViewTransition && event) {
			isAnimating = true
			const x = event.clientX
			const y = event.clientY
			const endRadius = Math.hypot(
				Math.max(x, innerWidth - x),
				Math.max(y, innerHeight - y)
			)

			const isDark = newTheme === 'dark'

			const transition = document.startViewTransition(() => {
				root.classList.toggle('dark')
			})

			transition.ready.then(() => {
				if (isDark) {
					// Light collapses inward
					document.documentElement.animate(
						{ clipPath: [`circle(${endRadius}px at ${x}px ${y}px)`, `circle(0px at ${x}px ${y}px)`] },
						{ 
							duration: 300, 
							easing: 'ease-out', 
							pseudoElement: '::view-transition-old(root)' 
						}
					)
				} else {
					// Light expands outward
					document.documentElement.animate(
						{ clipPath: [`circle(0px at ${x}px ${y}px)`, `circle(${endRadius}px at ${x}px ${y}px)`] },
						{ 
							duration: 300, 
							easing: 'ease-out', 
							pseudoElement: '::view-transition-new(root)' 
						}
					)
				}
			})

			transition.finished.finally(() => {
				isAnimating = false
			})
		} else {
			root.classList.toggle('dark')
		}
	}

	// Initial Setup
	setTheme(getUserPref())

	// View Transitions hook to restore theme
	document.addEventListener('astro:after-swap', () => setTheme(getUserPref()))

	// Listen for theme-change custom event
	document.addEventListener('theme-change', (e) => {
		setTheme(e.detail.theme, e.detail.event)
	})

	// Listen for prefers-color-scheme change
	lightModePref.addEventListener('change', (e) => setTheme(e.matches ? 'light' : 'dark'))
</script>
