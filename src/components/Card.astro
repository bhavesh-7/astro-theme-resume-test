---
import { Image } from 'astro:assets'
import type { ImageMetadata } from 'astro'
import { cn } from '@/utils'

const {
	as: Tag = 'div',
	class: className,
	href,
	heading,
	subheading,
	date,
	imagePath,
	altText,
	imageClass,
	collapsible = false
} = Astro.props
const images = import.meta.glob<{ default: ImageMetadata }>('/src/assets/*.{jpeg,jpg,png,gif}')

if (imagePath) {
	if (!images[imagePath])
		throw new Error(`"${imagePath}" does not exist in glob: "src/assets/*.{jpeg,jpg,png,gif}"`)
}

const uniqueId = `card-${Math.random().toString(36).substr(2, 9)}`
---

<Tag
	class={cn(
		className,
		'relative rounded-2xl border border-border bg-primary-foreground px-5 py-3',
		href && 'transition-all hover:border-foreground/25 hover:shadow-sm'
	)}
	href={href}
>
	{
		imagePath && (
			<Image
				src={images[imagePath]()}
				alt={altText}
				class={cn('mb-3 md:absolute md:mb-0', imageClass)}
				loading='eager'
			/>
		)
	}
	<div class='flex flex-col gap-y-1.5'>
		<div class='flex flex-col gap-y-0.5'>
			<h1 class='text-lg font-medium'>{heading}</h1>
			<h2 class='text-muted-foreground'>{subheading}</h2>
			<h2 class='text-muted-foreground'>{date}</h2>
		</div>
		<div id={uniqueId} class={collapsible ? 'collapsible-content' : ''}>
			<slot />
		</div>
		{collapsible && (
			<button
				class='mt-2 flex items-center gap-1 text-sm text-muted-foreground hover:text-foreground transition-colors'
				onclick={`toggleCollapse('${uniqueId}')`}
				data-collapse-btn={uniqueId}
			>
				<span class='toggle-text'>More</span>
				<svg
					xmlns='http://www.w3.org/2000/svg'
					width='16'
					height='16'
					viewBox='0 0 24 24'
					fill='none'
					stroke='currentColor'
					stroke-width='2'
					stroke-linecap='round'
					stroke-linejoin='round'
					class='toggle-icon transition-transform'
				>
					<polyline points='6 9 12 15 18 9'></polyline>
				</svg>
			</button>
		)}
	</div>
</Tag>

{collapsible && (
	<style>
		.collapsible-content {
			max-height: 120px;
			overflow: hidden;
			position: relative;
		}
		
		.collapsible-content.expanded {
			max-height: none;
		}
		
		.collapsible-content:not(.expanded)::after {
			content: '';
			position: absolute;
			bottom: 0;
			left: 0;
			right: 0;
			height: 60px;
			background: linear-gradient(to bottom, transparent, hsl(var(--primary-foreground)));
			pointer-events: none;
		}
		
		.toggle-icon.rotated {
			transform: rotate(180deg);
		}
	</style>
	
	<script is:inline>
		function toggleCollapse(id) {
			const content = document.getElementById(id);
			const btn = document.querySelector(`[data-collapse-btn="${id}"]`);
			const text = btn.querySelector('.toggle-text');
			const icon = btn.querySelector('.toggle-icon');
			
			if (content.classList.contains('expanded')) {
				content.classList.remove('expanded');
				text.textContent = 'More';
				icon.classList.remove('rotated');
			} else {
				content.classList.add('expanded');
				text.textContent = 'Less';
				icon.classList.add('rotated');
			}
		}
	</script>
)}
